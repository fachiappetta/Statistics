---
title: "Group Lab 1"
author: "Malkie Wall, Chrissie Pantoja, and Frankie Chiappetta"
date: "September 26, 2021"
output:
  html_document
---

## Interpretation
#### Introduction 
We analyzed water quality data from a study conducted by Molofsky et al. (2013) examining methane concentrations in 1,701 drinking wells in Susquehanna County, Pennsylvania. Drinking wells were classified as either being in an upland area or in a valley area to characterize baseline groundwater quality conditions during the period of 2008 to 2011 (see Molofsky et al., 2013). We tested whether methane levels are greater in water wells near fracking sites than in water wells farther away from fracking sites. We conducted four comparisons of means: (1) Methane levels near fracking sites vs. Methane levels far from fracking sites for all observations, (2) Methane levels near fracking sites vs. Methane levels far from fracking sites for valley observations, (3) Methane levels near fracking sites vs. Methane levels far from fracking sites for upland observations, and (4) Methane levels in the valley vs. Methane levels in the upland. 

​​The variables in the data set include:
**ID**: well ID number;
**Methane**: ug/L methane in well water;
**Location**: *Valley* = well located in valley, *Upland* = well located in upland;
**Proximity**: *Near* = Well drilled with gas located < within 1 km from active fracking site prior to the time of sampling (gas production area); *Far* = Well drilled with no gas not located prior to sampling within 1 km radius of active of the fracking site (gas non-production area);
**DL**: *1* = value reported at detection limit (censored at detection limit); *0* = value above detection limit.

#### Data Description 
Our dataset contains 1,701 observations. Observations for *near* and *far* for all data skew strongly positive (Table 1), with values clustered around the lower tail in the original (Figure 1). In the logged data (Figure 5) observations for *far* skew strongly positive with a unimodal distribution while observations for *near* are more multimodal. The same trends are found for the *near* and *far* valley observations in the original data (Figure 2) and logged data (Figure 6). The distributions for upland sites for *far* skew strongly positive and are unimodal for both the original (Figure 3) and logged data (Figure 7), and the observations for *near* are more multimodal. The upland and valley distributions for all observations are positively skewed for the original (Figure 4) and the logged data (Figure 8).  The histograms appear more unimodal when we log the data (Figure 5-8). Across all observations, methane concentrations range from 0.0500 ug/L to 43,000 ug/L. Far upland observations range from (0.0500, 32,000 ug/L methane), while the near upland observations range from (0.1000, 8,300 ug/L methane). 


As many of the distributions are highly skewed, we will report the median of the data. The median methane concentration for wells farther from fracking sites (n = 1,379, median = 0.6000, sd = 3,133 ug/L) is higher than that near fracking sites (n = 322, median = 5.900, sd = 4,087 ug/L) (Table 1). For valley site observations, the median methane concentration is higher in wells near fracking sites (n=195, median = 19.00 ug/L, sd = 5,172 ug/L) than in wells farther from fracking sites (n =670, median = 1.30 ug/L, sd =4,059 ug/L ) (Table 2). The median methane concentration in upland wells is higher near fracking sites (n= 127, median = 1.400 ug/L, sd=799 ug/L) than the median methane concentration in wells that are farther away from fracking sites (n= 709, median = 0.4000 ug/L, sd=1753 ug/L) (Table 3). The median methane concentrations for upland sites (n = 836, median = 0.470 ug/L, sd = 1,644 ug/L) are lower than methane concentrations for valley sites (n = 865, median =  1.800 ug/L, sd = 4,332 ug/L) (Table 4)

*Censored Observations*. 370 of 1331 observations are “censored”, meaning the value of methane concentration was reported at the detection limit. Of the 322 observations near fracking wells, more than a third (n=117) were censored. Observations farther from fracking wells were censored at a much lower rate (n=253 of 1,379). Observations were also censored at varying methane concentrations (min. censored value = 0.1000 ug/L, max censored value = 26.00 ug/L). Figure 9 shows that the censored observations farther from fracking wells tended to be censored at lower concentrations of methane (median =  0.1000 ug/L), whereas the censored observations near fracking wells were censored at a relatively higher levels of methane (median = 26.00 ug/L). Since roughly a quarter of our observations are recorded at an arbitrary detection limit --  and that the detection limits are different between near and far observations -- our sample distributions may not accurately reflect the underlying population. 

#### Statistical Analysis and Discussion
We ran three comparison of means tests (a Welch’s two-sample t-test, a Welch’s two-sample t-test on logged data, and a non-parametric Wilcoxon test) for each one of our four hypotheses. 

##### Methane levels (ug/L) near fracking sites vs. Methane levels (ug/L) far from fracking sites for ALL observations. 
For the first comparison we suspected that methane levels near fracking sites would be higher than methane levels far from fracking sites (H0: mu_near - mu_far <= 0; Ha: mu_near - mu_far > 0), so we performed a two-sample, one-sided t-test. The Welch’s t-test provided no evidence to suggest that wells near fracking sites have higher methane levels than wells further from fracking sites (t = -0.45603, df = 413.32, p-value = 0.3243). However, a Welch’s t-test with logged data provided strong evidence (p<0.01) that methane levels near fracking sites were higher than methane levels far from fracking sites (t = -4.9723, df = 520.92, p-value = 4.499e-07). Our results from the Shapiro-Wilk normality tests for data on near (p-value < 2.2e-16) and far wells (p-value < 2.2e-16) and logged data for near (p-value = 9.473e-14) and far wells (p-value < 2.2e-16), indicate that our samples follow a non-normal distribution. Given our large sample sizes (n= 322 and n= 1,379), however, the results of the two sample Welch’s t-test are robust to this violation of the assumption of normality. We also ran a non-parametric Wilcoxon rank sum test. Our results (W = 171369, p-value = 8.21e-11) suggest that the samples were likely not derived from the same population. Finally, we estimated the multiplicative factor of the medians as 0.4021 ug/L methane, meaning the median methane level (ug/L) in the wells far from fracking sites is estimated to be 40.2% of the median methane level (ug/L) in wells near fracking sites. We are 95% confident that the interval (0 ug/L, 0.5438 ug/L) includes the true multiplicative factor of the medians.

#####  Methane levels near fracking sites vs. Methane levels far from fracking sites for valley observations .
For the second comparison, we used a two-sample, one-sided t-test (H0: mu_near - mu_far <= 0; Ha: mu_near - mu_far > 0).  The Welch’s t-test (t = -0.097458, df = 267.29, p-value = 0.4612) provided no evidence to suggest that wells near fracking sites have higher methane levels than wells further from fracking sites in valley observations. The results of our Welch’s t-test test (t = -1.8711, df = 377.96, p-value = 0.03105) using logged methane levels provide moderate evidence (p < 0.05) that valley methane levels near fracking sites are greater than valley methane levels far from fracking sites. Given the skew using the original data, the t-test using logged methane levels is likely more reliable. In the Shapiro-Wilks test for both the original (near: p-value < 2.2e-16, far: p-value < 2.2e-16) and logged data (near: p-value < 1.531e-11, far: p-value 2.2e-16), we rejected the null hypothesis, meaning our samples were not pulled from a normally distributed population. The results of our  nonparametric  Wilcoxon rank sum test (W = 55564, p-value = 0.0007267) suggest that the population distribution of  methane levels near valley fracking sites are not the same as valley methane levels far from fracking sites. The multiplicative factor of the medians for valley sites is 0.6178 ug/L. This means that the median methane level (ug/L) in the farther wells is estimated to be 61.8% of the median methane level (ug/L) in wells near fracking sites for valley sites. We are 95% confident that the interval (0 ug/L, 0.9444  ug/L) includes the true multiplicative factor of the medians.

#####  Methane levels near fracking sites vs. Methane levels far from fracking sites for upland observations. 
We used a two-sample, one-sided t-test (H0: mu_near - mu_far <= 0; Ha: mu_near - mu_far > 0), for the same reason as comparison 2. Our original Welch’s t-test provided no evidence to suggest that wells near fracking sites have higher methane levels than wells further from fracking sites for upland observations (t = 0.78372, df = 385.64, p-value = 0.7832). The results of a Welch’s test with logged methane levels (t = -4.4239, df = 168.44, p-value = 8.674e-06) provide strong evidence that methane levels near fracking sites are higher than methane levels far from fracking sites at upland sites. The results from our Shapiro-Wilks test for both the original (near: W = 0.15112, p-value < 2.2e-16, far: W = 0.097424, p-value < 2.2e-16) and logged data (near: W = 0.91831, p-value = 1.061e-06, far: W = 0.82129, p-value < 2.2e-16), suggest that our samples were not pulled from a normally distributed population. The t-test using logged methane levels is therefore more reliable. The Wilcoxon rank sum test (W = 32805, p-value = 5.267e-07) provides strong evidence in support of the alternative hypothesis, suggesting the population of methane levels are not equal near fracking sites as compared to far from fracking sites in valley observations. The multiplicative factor of the medians for upland sites is 0.3233 ug/L. This means that the median methane level (ug/L) in the farther wells is estimated to be 32.3% of the median methane level (ug/L) in wells near fracking sites for upland sites. We are 95% confident that the interval (0 ug/L, 0.4931 ug/L) includes the true multiplicative factor of the medians.

#####  Methane levels in the valley vs. Methane levels in the upland. 
We used a two-sample, one-sided t-test (H0: mu_valley - mu_upland <= 0; Ha: mu_valley - mu_upland > 0), for the same reason as before. Our original Welch’s t-test provided convincing evidence (t = -6.3154, df = 1115.1, p-value = 1.942e-10) that valley observations have higher methane levels than upland observations. The results of a Welch’s test with logged methane levels (t = -9.3123, df = 1580.2, p-value < 2.2e-16) also provide strong evidence that valley observations have higher methane levels than upland observations. In the Shapiro-Wilks test for both the original ( valley: W = 0.30852, p-value < 2.2e-16, upland: W = 0.097797, p-value < 2.2e-16) and logged data (valley:  W = 0.84375, p-value < 2.2e-16, upland: W = 0.88635, p-value < 2.2e-16), we rejected the null hypothesis, meaning our samples were not pulled from a normally distributed population. The t-test using logged methane levels is therefore more reliable. The Wilcoxon rank sum test (W = 284413, p-value = 1.177e-14) provides strong evidence in support of the alternative hypothesis, suggesting the population of methane levels are not equal near fracking sites as compared to far from fracking sites in valley observations. The multiplicative factor of the medians for valley sites is 0.2489 ug/L - meaning that the median methane level in valley wells is estimated to be roughly 25% of the median methane level in upland wells. We are 95% confident that the interval (0, 0.3182 ug/L) includes the true multiplicative factor of the medians.

#### Conclusion 
Our results suggest that methane concentrations in drinking water wells near fracking sites are greater than those farther from fracking sites. Specifically, the results of Welch’s t-test on logged methane concentrations (ug/L) provide strong evidence (p<0.01) that methane levels near fracking sites are higher than methane levels far from fracking sites; that methane concentrations in wells near fracking sites are higher than wells farther from fracking sites in valley observations; that methane concentrations near fracking sites are higher than methane concentrations farther from fracking sites in upland observations; and methane concentrations in valley sites are higher than methane concentrations in upland sites. 

Typically the Welch’s t-test assumes a normal distribution. However, as the sample size in the two samples gets large, the t-test can still be valid even when the groups do not follow the normal distribution. Meeting the assumptions of the t-tests are more critical when sample sizes are small, skewness differs, and normality assumptions are not met. Despite non-normal distributions of the data, the  robustness of the two-sample test, the samples shewing in similar directions, and the sample sizes greater than 40 (Tables 1-4) suggest that the Welch's t-tests of the log data are reliable. Another concern is that the results of our Wilcoxon rank sum tests suggest that the populations being compared have different shapes. Moreover, while we assume independence of observations between or within groups, spatial autocorrelation should be something to consider.

Molofsky et al. (2013)’s analysis failed to address these population distribution issues. Molofsky et al. (2013) made statistical inferences about the methane concentrations only using Wilcoxon Rank Sum. However, our results suggest that the near vs far groups for all the data, valley sites and upland sites do not have similarly shaped distributions. Therefore, the Wilcoxon Rank Sum test should only be used to talk about differences between the populations in this scenario -- not to compare means of those populations. Another shortcoming of the Molofsky et. al article is that they don’t consider logged data and that they do not address the censored observations.

Molofsky et al. (2013) implies that the methane levels are correlated with topography (e.g., valley and uplands) - rather than proximity to fracking sites. However, our results suggest that fracking activities likely are associated with higher methane concentrations, which would have a negative impact on water quality. The data was randomly sampled, so the results we find are generalizable to methane levels in drinking water across Susquehanna County, Pennsylvania. If this is the case, policymakers should take action to protect drinking water from fracking activities in order to protect public health. 

Reference:
Data were downloaded from the supplemental material associated with the article by: Molofsky, L.J., Connor, J.A., Wylie, A.S., Wagner, T. and S.K. Farhat. (2013). Evaluation of Methane Sources in Groundwater in Northeastern Pennsylvania. Groundwater, 51(3): 333-349.



## Annex I: Descriptive Statistics

```{r libraries, message=FALSE, echo = FALSE, results = FALSE, warning=FALSE}
library(ggplot2) #make plots
library(dvmisc)
library(scales)
library(glue) #glue together text and variables
library(ggthemes)
library(papeR)
library(moments) #package for skewness
library(knitr) #package for making tables (kable)
library(tidyverse) #multiple packages for data wrangling
library(gt) # a package to make tables
```

```{r, echo = FALSE, results = FALSE, message=FALSE}
#read in dataframe and look at it
fracking_df = read.csv("PAFracking.csv")
glimpse(fracking_df)
```


#### *Methane levels near fracking sites vs. Methane levels far from fracking sites for ALL observations*

```{r ALL summary , echo = FALSE, results=FALSE, message=FALSE}
#MALKIE - ALL summary 
summary_fracking <- fracking_df %>% 
  dplyr::group_by(proximity) %>%
  select(methane) %>%
  dplyr::summarize(
                    length_methane=length(methane),
                    median_methane=median(methane),
                    mean_methane=mean(methane),
                    min_methane=min(methane),
                    max_methane=max(methane),
                    sd_methane=sd(methane),
                    skew_methane=skewness(methane),
                    ) 

glimpse(summary_fracking)
```

```{r ALL summary gt, echo = FALSE, warning=FALSE}
#MALKIE - ALL summary gt
summary_fracking %>%
gt() %>%
  
  tab_options(
    table.width = pct(80)
  )%>%
  
  cols_width(
    vars(length_methane)~ px(100),
    everything() ~ px(80))%>%
  
  tab_header(
    title = md("Table 1. Summary Statistics of Methane Levels, By Proximity to Fracking Wells"),
    subtitle = md("ug/L methane in well water")) %>%
  
  fmt_passthrough (columns=c(proximity)) %>%
  fmt_number(columns = c(length_methane), decimals = 0) %>%
  fmt_number(columns = c(median_methane), decimals = 3) %>%
  fmt_number(columns = c(mean_methane), decimals=1) %>%
  fmt_number(columns = c(min_methane), decimals = 4) %>%
  fmt_number(columns = c(max_methane), decimals = 0) %>%
  fmt_number(columns = c(sd_methane), decimals = 0) %>%
  fmt_number(columns = c(skew_methane), decimals = 3) %>%

cols_label(
    length_methane = "Observations",
    median_methane = "Median",
    mean_methane = "Mean",
    min_methane = "Minimum",
    max_methane = "Maximum",
    sd_methane = "SD",
    skew_methane = "Skewness")
```


```{r ALL histogram original data, echo = FALSE, fig.height=5, fig.width=7}
#MALKIE - ALL histogram of original data
p<-ggplot(fracking_df, aes(x=methane, fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(proximity ~ .)+
labs(x="Methane concentrations in ug/L", title="Figure 1. Methane Levels in Well Water for Sites Near Fracking Wells (n=322) \nand Far from Fracking Wells (n=1,379) in Pennsylvania",
     fill="Proximity to Well") + theme(plot.title = element_text(size = 12))
```



#### *Methane levels near fracking sites vs. Methane levels far from fracking sites for valley observations*

```{r VALLEY filter, echo = FALSE, results = FALSE}
#VALLEY filter data
valley_fracking <- fracking_df %>% dplyr::filter(location == "Valley")
head(valley_fracking)
```

```{r VALLEY summary, echo = FALSE, results = FALSE, message=FALSE, warning=FALSE}
#VALLEY: summary table

summary_valley_fracking <-valley_fracking %>% 
  dplyr::group_by(proximity) %>%
  select(methane) %>%
  dplyr::summarize(
                    length.methane=length(methane),
                    mean.methane=mean(methane),
                    median.methane=median(methane),
                    min.methane=min(methane),
                    max.methane=max(methane),
                    sd.methane=sd(methane),
                    skew.methane=skewness(methane),
                    )

summary_valley_fracking
```

```{r gt summary table, echo = FALSE}
#VALLEY: make gt summary box
summary_valley_fracking %>%
gt() %>%
  tab_header(
    title = md("Table 2. Summary Statistics of Methane Levels for Far and Near Valley Sites"),
    subtitle = "Methane measured in ug/L") %>%
  
 
  fmt_passthrough (columns=c(proximity)) %>%
  fmt_number(columns = c(length.methane), decimals = 0) %>%
  fmt_number(columns = c(mean.methane), decimals=0) %>%
  fmt_number(columns = c(median.methane), decimals = 2) %>%
  fmt_number(columns = c(min.methane), decimals = 4) %>%
  fmt_number(columns = c(max.methane), decimals = 0) %>%
  fmt_number(columns = c(sd.methane), decimals = 0) %>%
  fmt_number(columns = c(skew.methane), decimals = 3) %>%

cols_label(
    proximity="proximity",
    length.methane = "Observations",
    mean.methane = "Mean",
    median.methane = "Median",
    min.methane = "Minimum",
    max.methane = "Maximum",
    sd.methane = "SD",
    skew.methane = "Skewness")
  
```


```{r histograms original, echo = FALSE, fig.height=5, fig.width=7}
#VALLEY
p<-ggplot(valley_fracking, aes(x=methane, fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(proximity ~ .)+
labs(x="Methane concentrations in ug/L", title="Figure 2. Methane levels in ug/L in Well Water for Valley Sites Near Fracking \nWells (n=195) and Far from Fracking Wells (n=670) in Pennsylvania",
     fill="Proximity") + theme(plot.title = element_text(size = 12))


```

#### *Methane levels near fracking sites vs. Methane levels far from fracking sites for upland observations*



```{r filter upland,echo = FALSE, results = FALSE}
#filter the data for upland
upland_fracking.df<-fracking_df %>%
                      filter(proximity=="Near"|
					            proximity=="Far") %>%
                      filter(location=="Upland")
head(upland_fracking.df)

```


```{r summarytable upland, echo = FALSE, results = FALSE, message=FALSE}

#summary for upland
summary_upland_fracking.df <-upland_fracking.df %>% 
  dplyr::group_by(proximity) %>%
  select(methane) %>%
  dplyr::summarize(
                    length.methane=length(methane),
                    mean.methane=mean(methane),
                    median.methane=median(methane),
                    min.methane=min(methane),
                    max.methane=max(methane),
                    sd.methane=sd(methane),
                    skew.methane=skewness(methane),
                    )

glimpse(summary_upland_fracking.df)

```

```{r summary upland gt, echo = FALSE, message=FALSE}
#summary for upland fracking
summary_upland_fracking.df %>%
gt() %>%
  tab_header(
    title = md("Table 3. Summary Statistics of Methane Levels in Near and Far Upland"),
    subtitle = "methane measured in ug/L") %>%
  
  fmt_passthrough (columns=c(proximity)) %>%
  fmt_number(columns = c(length.methane), decimals = 0) %>%
  fmt_number(columns = c(mean.methane), decimals=1) %>%
  fmt_number(columns = c(median.methane), decimals = 3) %>%
  fmt_number(columns = c(min.methane), decimals = 4) %>%
  fmt_number(columns = c(max.methane), decimals = 0) %>%
  fmt_number(columns = c(sd.methane), decimals = 0) %>%
  fmt_number(columns = c(skew.methane), decimals = 2) %>%

cols_label(
    proximity="Proximity",
    length.methane = "Observations",
    mean.methane = "Mean",
    median.methane = "Median",
    min.methane = "Minimum",
    max.methane = "Maximum",
    sd.methane = "SD",
    skew.methane = "Skewness"  )
  
```

```{r histogram upland original data, echo = FALSE, fig.height=5, fig.width=7}
#UPLAND
histo<-ggplot(upland_fracking.df, aes(x=log(methane), fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

histo + facet_grid(proximity ~ .)+
labs(x="Methane concentration in ug/L", title="Figure 3. Methane levels in ug/L in Well Water for Upland Sites Near \nFracking Wells (n=127) and Far from Fracking Wells (n=709) in Pennsylvania",
     fill="Proximity to Well")+ theme(plot.title = element_text(size = 12))
```

#### *Methane levels in the valley vs. Methane levels in the upland*

```{r upland & valley summary, echo= FALSE, message=FALSE, results=FALSE}
#upland & valley:summary
summary_valley_upland_fracking <-fracking_df %>% 
  dplyr::group_by(location) %>%
  select(methane) %>%
  dplyr::summarize(
                    length.methane=length(methane),
                    mean.methane=mean(methane),
                    median.methane=median(methane),
                    min.methane=min(methane),
                    max.methane=max(methane),
                    sd.methane=sd(methane),
                    skew.methane=skewness(methane),
                    )

summary_valley_fracking
```


```{r upland & valley summary gt, echo=FALSE}
#upland & valley: make gt summary box
summary_valley_upland_fracking %>%
gt() %>%
  tab_header(
    title = md("Table 4. Summary Statistics of Methane Levels for Upland and Valley Sites"),
    subtitle = "Methane measured in ug/L") %>%
  
 
  fmt_passthrough (columns=c(location)) %>%
  fmt_number(columns = c(length.methane), decimals = 0) %>%
  fmt_number(columns = c(mean.methane), decimals=0) %>%
  fmt_number(columns = c(median.methane), decimals = 3) %>%
  fmt_number(columns = c(min.methane), decimals = 4) %>%
  fmt_number(columns = c(max.methane), decimals = 0) %>%
  fmt_number(columns = c(sd.methane), decimals = 0) %>%
  fmt_number(columns = c(skew.methane), decimals = 2) %>%

cols_label(
    location="location",
    length.methane = "Observations",
    mean.methane = "Mean",
    median.methane = "Median",
      min.methane = "Minimum",
    max.methane = "Maximum",
    sd.methane = "SD",
    skew.methane = "Skewness")
  
```




```{r  upland & valley histograms original, echo = FALSE, fig.height=5, fig.width=7}
#upland & valley: histogram
p<-ggplot(valley_fracking, aes(x=(methane), fill=proximity))+
geom_histogram(col="black", bins =15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(proximity ~ .)+
labs(x="Methane concentrations in ug/L", title="Figure 4. Methane levels in ug/L in Well Water in Upland Sites (n=836) \nand in Valley Sites (n=865) in Pennsylvania",
     fill="Proximity to Wells") + theme(plot.title = element_text(size = 12))


```



## Annex 2: Comparison of Means Tests

#### *Methane levels near fracking sites vs. Methane levels far from fracking sites for ALL observations*

*Welch's t-test on original data*
```{r ttest original ALL, echo=FALSE}
#Assumes mean(Far)-mean(Near). Far has lower mean methane levels than Near, so the difference (and the confidence intervals) is in the negative range. 
#NEED TO CHECK THAT THIS INTUTION IS RIGHT.

t.test(methane ~ proximity, fracking_df, alternative= "less")
```

*Test for normality on original data*
```{r, echo=FALSE, results = FALSE}
#Creates new data table for proximity=Near
near_fracking_df <- fracking_df %>% filter(proximity == "Near")%>%
   glimpse()

#Creates new data table for proximity=Far
far_fracking_df <- fracking_df %>% filter(proximity == "Far")%>%
   glimpse()
```

```{r, echo=FALSE}
#Run Shapiro on Near
near_fracking_df<-fracking_df %>%
  filter(proximity =="Near")

shapiro.test(near_fracking_df$methane)

#Run Shapiro on Far
far_fracking_df<-fracking_df %>%
  filter(proximity =="Far")

shapiro.test(far_fracking_df$methane)
```

*Histogram on logged data*
```{r, echo=FALSE, messages = FALSE, fig.height=5, fig.width=7}
#Create a new variable of logged methane levels called log_methane and add to dataframe fracking_df
fracking_df$log_methane<-log(fracking_df$methane)
head(fracking_df)

#Make histogram of logged data
p<-ggplot(fracking_df, aes(x=log_methane, fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(proximity ~ .)+
labs(x="Logged methane concentrations in ug/L", title="Figure 5. Logged methane Levels in Well Water for Sites Near Fracking Wells (n=322) \nand Far from Fracking Wells (n=1,379) in Pennsylvania",
     fill="Proximity to Well") + theme(plot.title = element_text(size = 12))

```

*Shapiro-Wilk test on logged data*
```{r, echo = FALSE, results = FALSE}
#Check that Near and Far data frames have logged methane variable
near_fracking_df<-fracking_df %>%
  filter(proximity =="Near")
head (near_fracking_df)

far_fracking_df<-fracking_df %>%
  filter(proximity =="Far")
head (far_fracking_df)

```

```{r, echo= FALSE}
#Run Shapiro on Near_logged
shapiro.test(near_fracking_df$log_methane)

#Run Shapiro on Far_logged
shapiro.test(far_fracking_df$log_methane)
```

*Welch's t-test on logged data*
```{r, echo= FALSE}
#Assumes mean(Far)-mean(Near). Far has lower mean methane levels than Near, so the difference (and the confidence intervals) is in the negative range. 
#CONFIRM THAT THIS ASSUMPTION IS CORRECT.

log_ttest_all <- t.test(log_methane ~ proximity, fracking_df, alternative="less")
log_ttest_all
```

*Multiplicative factor of the median*
```{r, echo = FALSE, results=FALSE}
str(t.test(log_methane ~ proximity, fracking_df, alternative="less"))
logged_mean_far_fracking <- t.test(log_methane ~ proximity, data=fracking_df)$estimate[1]
logged_mean_near_fracking <- t.test(log_methane ~ proximity, data=fracking_df)$estimate[2]
```

```{r, echo = FALSE, results = FALSE}
#means
logged_mean_far_fracking
logged_mean_near_fracking
```

```{r, echo = FALSE}
#Again, mean(Far) - mean (Near)
#Exponentiate difference of log data to get multiplicative factor of the medians.

exp_mean_diff<- exp(logged_mean_far_fracking - logged_mean_near_fracking)
glue("The multiplicative factor of the medians for all sites (far - near) is {round(exp_mean_diff,4)} ug/L")
```

*Confidence interval the logged data*
```{r, echo = FALSE}
#Now, we also need to back transform the confidence interval and that becomes the confidence interval for the multiplicative factor of the medians! 

#THESE ARE THE NUMBERS FROM THE TUTORIAL.  MY OUTPUT SAYS -Inf -0.6091616. WHAT DO I MAKE OF THAT?
#95 percent confidence interval:
       #-Inf -0.6091616

lower.exp<-exp(log_ttest_all$conf.int[1])
upper.exp<-exp(log_ttest_all$conf.int[2])

glue("The confidence interval for all sites for far and near is {lower.exp} to {round(upper.exp,4)} ug/L")


#The 95% confidence interval for the multiplicative factor of the medians is (lower.exp, upper.exp). We are 95% confidence that this interval includes the true multiplicative factor of the medians!
```

*Non-parametric test = Wilcox test*
```{r, echo = FALSE}
wilcox.test(methane ~ proximity, data = fracking_df, alternative = "less")

```


####  *Methane levels near fracking sites vs. Methane levels far from fracking sites for valley observations*

*Welch's t-test on original data*
```{r original data ttest, echo= FALSE}
##VALLEY: Welch t test for original data
ttest_original_valley <- t.test(methane ~ proximity, valley_fracking, alternative= "less")
ttest_original_valley
```



*Test for normality on original data*
```{r sw.far.original, echo = FALSE}
##VALLEY: Shapiro Wilk test for original data of valley sites: far 
valley_fracking_far <-valley_fracking %>%
  filter(proximity =="Far")


shapiro.test(valley_fracking_far$methane)
```

```{r sw.near.original, echo = FALSE}
##VALLEY: Shapiro Wilk test for original data of valley sites: near
valley_fracking_near <-valley_fracking %>%
  filter(proximity =="Near")


shapiro.test(valley_fracking_near$methane)
```

```{r log, echo = FALSE, results = FALSE}
#VALLEY: save new column as log methane
valley_fracking$log_methane <- log(valley_fracking$methane)
head(valley_fracking)
```

*Histogram on logged data *
```{r histograms logged valley, echo = FALSE, fig.height=5, fig.width=7}
#VALLEY
p<-ggplot(valley_fracking, aes(x=log_methane, fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(proximity ~ .)+
labs(x="Logged methane concentrations in ug/L", title="Figure 6. Logged methane levels in ug/L in Well Water for Valley Sites Near \nFracking Wells (n=195) and Far from Fracking Wells (n=670) in Pennsylvania",
     fill="Proximity") + theme(plot.title = element_text(size = 12))


```


*Shapiro-Wilk test on logged data*
```{r sw.far.log, echo = FALSE}
#VALLEY: Shapiro Wilk test for logged data of valley sites: far 
valley_fracking_far <-valley_fracking %>%
  filter(proximity =="Far")


shapiro.test(valley_fracking_far$log_methane)
```

```{r sw.near.log, echo=FALSE}
#VALLEY: Shapiro Wilk test for logged data of valley sites: near 
valley_fracking_near <-valley_fracking %>% filter(proximity =="Near")

shapiro.test(valley_fracking_near$log_methane)
```

*Welch's t-test on logged data*
```{r log ttest, echo=FALSE}
#VALLEY: Welch t test for logged data
log_ttest_valley <- t.test(log_methane ~ proximity, valley_fracking, alternative= "less")
log_ttest_valley
```

*Confidence interval for the logged data*
```{r valley CI, echo = FALSE}
#CONFIDENCE INTERVAL
CI_lower_valley <- exp(log_ttest_valley$conf.int[1])
CI_upper_valley <- exp(log_ttest_valley$conf.int[2])


glue("The confidence interval for valley sites for far and near is {CI_lower_valley} to {round(CI_upper_valley,4)} ug/L")
```

*multiplicative factor of the medians*
```{r, echo = FALSE}
exp_mean_diff <- exp(log_ttest_valley$estimate[1] - log_ttest_valley$estimate[2])
glue("The multiplicative factor of the medians for valley sites (far - near) is {round(exp_mean_diff,4)} ug/L")

```


*Non-parametric test = Wilcox test*
```{r, echo = FALSE}
#VALLEY: wilcox test, non parametric
wilcox_valley_fracking <- wilcox.test(methane ~ proximity, data = valley_fracking, alternative = "less")
wilcox_valley_fracking
```

#### *Methane levels near fracking sites vs. Methane levels far from fracking sites for upland observations*

*Welch's t-test on original data*

```{r t.test, echo = FALSE}

t.test(methane ~ proximity, upland_fracking.df, alternative = "less")

```


*Test for normality on original data*


```{r near upland.df.sw, echo = FALSE}

upland_fracking_near.df<-upland_fracking.df %>%
  filter(proximity=="Near") 

shapiro.test(upland_fracking_near.df$methane)

```

```{r far upland.df.ca, echo=FALSE}
upland_fracking_far.df<-upland_fracking.df %>%
  filter(proximity=="Far")

shapiro.test(upland_fracking_far.df$methane)

```

*Histogram on logged data *

```{r, echo=FALSE, results=FALSE}
#created logged data
upland_fracking.df$log.methane<-log(upland_fracking.df$methane)
head(upland_fracking.df)
```

```{r histogram upland logged data, echo = FALSE, fig.height=5, fig.width=7}
#upland
histo<-ggplot(upland_fracking.df, aes(x=log.methane, fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

histo + facet_grid(proximity ~ .)+
labs(x="Logged methane concentration in ug/L", title="Figure 7. Logged methane levels in ug/L in Well Water for Upland Sites Near Fracking \nWells (n=127) and Far from Fracking Wells (n=709) in Pennsylvania",
     fill="Proximity to Well")+ theme(plot.title = element_text(size = 12))
```

*Shapiro-Wilk test on logged data*

```{r upland sw.far.log, echo = FALSE}
#Upland: Shapiro Wilk test for logged data of valley sites: far 
upland_fracking_far.df <-upland_fracking.df %>%
  filter(proximity =="Far")


shapiro.test(upland_fracking_far.df$log.methane)
```

```{r upland sw.near.log, echo=FALSE}
#Upland: Shapiro Wilk test for logged data of valley sites: near 
upland_fracking_near.df <- upland_fracking.df %>% filter(proximity =="Near")

shapiro.test(upland_fracking_near.df$log.methane)
```

*Welch's t-test on logged data*

```{r, echo = FALSE, echo=FALSE}
log_test_upland <- t.test(log.methane ~ proximity, upland_fracking.df, alternative="less")
log_test_upland
```



*Confidence interval for the logged data*
```{r upland logged CI, echo = FALSE}
#CONFIDENCE INTERVAL
CI_lower_upland <- exp(log_test_upland$conf.int[1])
CI_upper_upland <- exp(log_test_upland$conf.int[2])

glue("The confidence interval for upland sites for far and near is {CI_lower_upland} {round(CI_upper_upland,4)} ug/L")

```

*difference in multiplicative factor of medians*
```{r, echo = FALSE}
exp_mean_diff <- exp(log_test_upland$estimate[1] - log_test_upland$estimate[2])
glue("The multiplicative factor of the medians for valley sites (far - near) is {round(exp_mean_diff,4)} ug/L")
```


*Non-parametric test = Wilcox test*
```{r, echo =  FALSE}
#Upland: wilcox test, non parametric
wilcox_upland_fracking <- wilcox.test(methane ~ proximity, data = upland_fracking.df, alternative = "less")
wilcox_upland_fracking

```



#### *Methane levels in the valley vs. Methane levels in the upland*

*Welch's t-test on original data*
```{r upland & valley original data ttest, echo = FALSE}
#upland & valley: Welch t test for original data
ttest_original_valley_upland <- t.test(methane ~ location, fracking_df, alternative = "less")
ttest_original_valley_upland
```

*Test for normality on original data*
```{r upland & valley create upland & valley, echo = FALSE}
#Creates new data table for location is valley
valley_fracking_df <- fracking_df %>% filter(location == "Valley")

#Creates new data table for location is upland
upland_fracking_df <- fracking_df %>% filter(location == "Upland")
```

```{r upland & valley sw, echo = FALSE}
shapiro.test(valley_fracking_df$methane)

shapiro.test(upland_fracking_df$methane)
```

*Histogram on logged data*
```{r upland & valley histograms logged, echo = FALSE, message=FALSE, fig.height=5, fig.width=7}

#VALLEY: histogram on logged data
p<-ggplot(fracking_df, aes(x=log_methane, fill=location))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(location ~ .)+
labs(x="Logged methane concentration in ug/L", title="Figure 8.  Logged methane levels in ug/L in Well Water for All Sites Near Fracking \nWells (n=127) and Far from Fracking Wells (n=709) in Pennsylvania",
     fill="Proximity to Well")+ theme(plot.title = element_text(size = 12))



```


*Shapiro-Wilk test on logged data*
```{r upland & valley logged sw for upland, echo = FALSE}
#upland & valley: Shapiro Wilk test for logged data of upland sites 
shapiro.test(upland_fracking_df$log_methane)
```

```{r upland & valley logged sw for valley, echo = FALSE}
#upland & valley: Shapiro Wilk test for logged data of valley sites 
shapiro.test(valley_fracking_df$log_methane)
```

*Welch's t-test on logged data*
```{r upland & valley log ttest, echo = FALSE}
#upland and valley: Welch t test for logged data
log_ttest_valley_upland <- t.test(log_methane ~ location, fracking_df, alternative = "less")
log_ttest_valley_upland
```

*Confidence Interval on logged data*
```{r upland & valley logged summary statistics, echo = FALSE}
#CONFIDENCE INTERVAL
CI_lower_valley_upland <- exp(log_ttest_valley_upland$conf.int[1])

CI_upper_valley_upland <- exp(log_ttest_valley_upland$conf.int[2])

glue("The confidence interval for all sites for upland and valley is {CI_lower_valley_upland} to {round(CI_upper_valley_upland,4)} ug/L")

```

*multiplicative factor of the medians*
```{r, echo = FALSE}
exp_mean_diff<- exp(log_ttest_valley_upland$estimate[1] - log_ttest_valley_upland$estimate[2])
glue("The multiplicative factor of the medians for all sites (upland - valley) is {round(exp_mean_diff,4)} ug/L")
```


*Non-parametric test = Wilcox test*
```{r upland & valley wilcox, echo = FALSE}
#VALLEY: wilcox test, non parametric
wilcox_valley_fracking <- wilcox.test(methane ~ location, data = fracking_df, alternative = "less")
wilcox_valley_fracking
```






## Annex 3: Censored data
```{r, echo = FALSE, message=FALSE, warning=FALSE}
#Create summary table for ALL
censored_df <- fracking_df %>% 
  dplyr::group_by(dl) %>%
  select(methane) %>%
  dplyr::summarize(
      length_methane=length(methane),
      median_methane=median(methane),
      min_methane=min(methane),
      max_methane=max(methane),
      mean_methane=mean(methane),
      )
```

```{r, echo= FALSE, message=FALSE, warning=FALSE}
#Create summary table for Near CENSORED
censored_near_df <- fracking_df %>% 
  filter(proximity == "Near") %>%
  dplyr::group_by(dl) %>%
  select(methane) %>%
  dplyr::summarize(
      length_methane=length(methane),
      median_methane=median(methane),
      min_methane=min(methane),
      max_methane=max(methane),
      mean_methane=mean(methane),
      )
```

```{r, echo= FALSE, message=FALSE, warning=FALSE}
#Create summary table for Far CENSORED
censored_far_df <- fracking_df %>% 
  filter(proximity == "Far") %>%
  dplyr::group_by(dl) %>%
  select(methane) %>%
  dplyr::summarize(
      length_methane=length(methane),
      median_methane=median(methane),
      min_methane=min(methane),
      max_methane=max(methane),
      mean_methane=mean(methane),
      )
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
#gt summary table for ALL CENSORED
censored_df %>%
gt() %>%
  
  tab_options(
    table.width = pct(80)
  )%>%
  
  cols_width(
    vars(length_methane)~ px(100),
    everything() ~ px(80))%>%
  
  tab_header(
    title = md("Table 5. Summary Statistics of Methane Levels for Uncensored (dl = 0) and Censored (dl = 1) Data"),
    subtitle = md("ug/L methane in well water")) %>%
  
  fmt_passthrough (columns=c(dl)) %>%
  fmt_number(columns = c(length_methane), decimals = 0) %>%
  fmt_number(columns = c(median_methane), decimals = 3) %>%
  fmt_number(columns = c(mean_methane), decimals=1) %>%
  fmt_number(columns = c(min_methane), decimals = 4) %>%
  fmt_number(columns = c(max_methane), decimals = 0) %>%

cols_label(
    length_methane = "Observations",
    median_methane = "Median",
    mean_methane = "Mean",
    min_methane = "Minimum",
    max_methane = "Maximum")
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
#gt summary table for: CENSORED NEAR
censored_near_df %>%
gt() %>%
  
  tab_options(
    table.width = pct(80)
  )%>%
  
  cols_width(
    vars(length_methane)~ px(100),
    everything() ~ px(80))%>%
  
  tab_header(
    title = md("Table 6. Summary Statistics of Methane Levels for Uncensored (dl = 0) and Censored (dl = 1) Data Near Fracking Sites "),
    subtitle = md("ug/L methane in well water")) %>%
  
  fmt_passthrough (columns=c(dl)) %>%
  fmt_number(columns = c(length_methane), decimals = 0) %>%
  fmt_number(columns = c(median_methane), decimals = 3) %>%
  fmt_number(columns = c(mean_methane), decimals=1) %>%
  fmt_number(columns = c(min_methane), decimals = 4) %>%
  fmt_number(columns = c(max_methane), decimals = 0) %>%

cols_label(
    length_methane = "Observations",
    median_methane = "Median",
    mean_methane = "Mean",
    min_methane = "Minimum",
    max_methane = "Maximum")
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
#gt summary table for: CENSORED FAR
censored_far_df %>%
gt() %>%
  
  tab_options(
    table.width = pct(80)
  )%>%
  
  cols_width(
    vars(length_methane)~ px(100),
    everything() ~ px(80))%>%
  
  tab_header(
    title = md("Table 7. Summary Statistics of Methane Levels for Uncensored (dl = 0) and Censored (dl = 1) Data Near Fracking Sites Far From Fracking Sites "),
    subtitle = md("ug/L methane in well water")) %>%
  
  fmt_passthrough (columns=c(dl)) %>%
  fmt_number(columns = c(length_methane), decimals = 0) %>%
  fmt_number(columns = c(median_methane), decimals = 3) %>%
  fmt_number(columns = c(mean_methane), decimals=1) %>%
  fmt_number(columns = c(min_methane), decimals = 4) %>%
  fmt_number(columns = c(max_methane), decimals = 0) %>%

cols_label(
    length_methane = "Observations",
    median_methane = "Median",
    mean_methane = "Mean",
    min_methane = "Minimum",
    max_methane = "Maximum")
```

```{r, echo = FALSE, results = FALSE, message=FALSE, warning=FALSE}
#Create new data frame of only censored values
censored_df1 <- fracking_df %>% filter(dl > 0)
censored_df1
```

```{r histograms censored, echo = FALSE, fig.height=5, fig.width=7}
#Histogram of censored data

p<-ggplot(censored_df1, aes(x=methane, fill=proximity))+
geom_histogram(col="black", bins = 15)+
scale_fill_manual(values=c("royalblue", "gray"))

p + facet_grid(proximity ~ .)+
labs(x="Methane concentrations in ug/L", title="Figure 9. Methane Levels of Censored Observations (dl = 1) in Well Water for Sites \nNear Fracking Wells (n=322) and Far from Fracking Wells (n=1,379) in Pennsylvania",
     fill="Proximity to Well") + theme(plot.title = element_text(size = 12))
```








